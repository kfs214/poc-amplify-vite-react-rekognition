# ADR-003: 同期的な顔照合API呼び出し

## ステータス
採用 (2025-10-28)

## コンテキスト
プロフィール写真とLiveness写真を照合する際、本番環境では非同期処理（S3イベント→Lambda→通知）が理想だが、PoCでの実装方法を決定する必要がある。

## 検討した選択肢

### 選択肢1: 非同期処理（本番想定）
```
1. S3にアップロード
2. S3イベントでLambdaトリガー
3. Rekognition処理
4. 結果をDynamoDBに保存
5. SNS/SQS/AppSyncでフロントエンドに通知
6. フロントエンドで結果を表示
```

**メリット**: 
- 本番環境に最も近い
- ユーザーは離脱可能（非同期なので）
- スケーラブル

**デメリット**: 
- 実装が複雑（+100行以上）
- イベント駆動アーキテクチャの構築が必要
- リアルタイム通知の実装（AppSync Subscription等）
- PoCの「Look & Feel」体験には過剰

### 選択肢2: 同期的なAPI呼び出し（採用）
```
1. フロントエンドからAPI.post('/compare')を呼び出し
2. Lambda関数で同期的にRekognition処理
3. 結果を即座にレスポンス
4. フロントエンドで結果を表示
```

**メリット**:
- 実装がシンプル（+30-40行程度）
- PoC体験がスムーズ（即座に結果が見える）
- デバッグしやすい
- REST APIの基本パターン

**デメリット**: 
- ユーザーが処理完了を待つ必要がある（2-5秒程度）
- 本番環境とは異なるアーキテクチャ

### 選択肢3: ポーリング（中間案）
```
1. 非同期処理開始
2. フロントエンドが定期的にステータスをポーリング
3. 完了したら結果を表示
```

**メリット**: 非同期とシンプルさの中間
**デメリット**: 
- 選択肢1より実装が簡単だが、選択肢2よりは複雑
- ユーザーは結局待つ（選択肢2と体験は同じ）
- PoCとしてメリットが少ない

## 決定
**選択肢2: 同期的なAPI呼び出し** を採用

## 理由
- PoCの目的は「Look & Feel」の体験であり、完全な本番実装ではない
- Rekognition処理は2-5秒程度で完了するため、PoC体験として許容範囲
- 実装がシンプルで、開発速度を優先できる
- デザイナーに「本番では非同期」と注記を表示することで、アーキテクチャの違いを伝えられる

## 実装
- REST API `/compare` エンドポイント（POST）
- Lambda関数で同期的にRekognition `CompareFaces` APIを呼び出し
- フロントエンドでローディング表示（Loader + "顔照合中..."メッセージ）
- 画面に注記を表示: "ℹ️ PoC用の同期実装です。本番環境では非同期処理となり、ユーザーは待たずに離脱可能です。"

## 影響
- ユーザーは2-5秒程度の待ち時間を体験する
- デザイナーに「ぐるぐるが長いのはPoC特有」と理解してもらう必要がある
- Lambda関数のタイムアウト設定を適切に設定（30秒程度）
- 画面Cでのローディング表示が必須

## トレードオフ
| 観点 | 同期 | 非同期 |
|------|------|--------|
| 実装複雑性 | 低 | 高 |
| 開発時間 | 1-2時間 | 5-8時間 |
| PoC体験 | 良好（即座に結果） | 複雑（通知待ち） |
| 本番との差 | 大 | 小 |

## 参考
- MASTER_PLAN.md マイルストーン6, 9
- ユーザーからの設計思想: "同期的に呼び出してローディングを見せる方が実装が圧倒的にシンプル（ミニマム）"

